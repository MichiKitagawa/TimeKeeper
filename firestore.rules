rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // users コレクション
    // 認証されたユーザーは、自分のユーザーIDと一致するドキュメントのみ読み書き可能
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // ドキュメント作成時、または currentLimit がまだ存在しない場合に限り currentLimit を書き込み可
      // challengeId はいつでも更新可
      allow write: if request.auth != null && request.auth.uid == userId
                   && (request.resource.data.currentLimit is number && (!exists(/databases/$(database)/documents/users/$(userId)) || !('currentLimit' in resource.data) || resource.data.currentLimit == null)
                       || !(request.resource.data.currentLimit != resource.data.currentLimit) // currentLimitの変更を通常は許可しない
                      )
                   && (request.resource.data.challengeId is string || request.resource.data.challengeId == null);
       // usersドキュメント作成時のより詳細なルール (必要であれば)
       // allow create: if request.auth != null && request.auth.uid == userId && ... ;
       // usersドキュメント更新時のより詳細なルール (上記writeでカバーしきれない場合)
       // allow update: if request.auth != null && request.auth.uid == userId && ... ;
    }

    // deposits コレクション
    match /deposits/{depositId} {
      // 認証されたユーザーは、自分のuserIdを持つドキュメントを読み取り可能
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // 認証されたユーザーは、自分のuserIdで、指定された条件でドキュメントを作成可能
      allow create: if request.auth != null
                      && request.auth.uid == request.resource.data.userId
                      && request.resource.data.refundAmount is number && request.resource.data.refundAmount > 0
                      && request.resource.data.feeRate is number && request.resource.data.feeRate >= 0 && request.resource.data.feeRate < 1
                      && request.resource.data.chargedAmount is number && request.resource.data.chargedAmount >= request.resource.data.refundAmount
                      && request.resource.data.status == 'pending'
                      && request.resource.data.createdAt == request.time
                      && request.resource.data.updatedAt == request.time
                      && (request.resource.data.transactionId == null || request.resource.data.transactionId is string);
      // 更新と削除は現時点では許可しない (必要に応じて変更)
      allow update, delete: if false;
    }

    // challenges コレクション
    match /challenges/{challengeId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null
                      && request.auth.uid == request.resource.data.userId
                      && request.resource.data.initialLimitMinutes is number && request.resource.data.initialLimitMinutes > 0 && request.resource.data.initialLimitMinutes <= 1440
                      && request.resource.data.status == 'active'
                      && request.resource.data.startDate == request.time;
                      // currentDailyLimitMinutes と remainingDays はCloud Functionsが設定するため、ここでは検証しない
      // 更新・削除は現時点では許可しない (Cloud Functionsからの更新は別途考慮)
      allow update, delete: if false;
    }

    // 他のコレクションに対するルールは、必要になった時点でここに追加していきます。
    // 例:
    // match /deposits/{depositId} {
    //   // ... depositsコレクションのルール ...
    // }
  }
} 